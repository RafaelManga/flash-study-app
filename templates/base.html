<!DOCTYPE html>
<html lang="pt-BR" data-theme="{{ usuario.tema if usuario else 'dark' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}FlashStudy{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/competicao.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧠</text></svg>">
</head>
<body>
    {% if usuario %}
    <div class="topbar">
        <a href="{{ url_for('admin_dashboard') if usuario.is_admin else url_for('home') }}" class="brand">🧠 FlashStudy{% if usuario.is_admin %} - Admin{% endif %}</a>

        <nav class="main-nav">
            {% if not usuario.is_admin %}
                <!-- Interface para usuários comuns -->
                <a href="{{ url_for('home') }}" class="nav-item">🏠 Início</a>
                <a href="{{ url_for('criar_card') }}" class="nav-item">➕ Criar Card</a>
                <a href="{{ url_for('gerar_ia') }}" class="nav-item">🤖 IA</a>
                <a href="{{ url_for('desafio') }}" class="nav-item">🎯 Desafio</a>
                <a href="{{ url_for('amigos') }}" class="nav-item">
                    👥 Amigos
                    {% if notificacoes_count > 0 %}
                    <span class="notification-badge">{{ notificacoes_count }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('pagina_competicao') }}" class="nav-item">🏆 Competições</a>
                <a href="{{ url_for('insights') }}" class="nav-item">📊 Insights</a>
                <a href="{{ url_for('perfil') }}" class="nav-item">👤 Perfil</a>
            {% else %}
                <!-- Interface exclusiva para administradores -->
                <a href="{{ url_for('admin_dashboard') }}" class="nav-item">📊 Painel Admin</a>
                <a href="{{ url_for('admin_users') }}" class="nav-item">👥 Usuários</a>
                <a href="{{ url_for('admin_reports') }}" class="nav-item">📢 Relatos</a>
                <a href="{{ url_for('admin_communication') }}" class="nav-item">💬 Comunicação</a>
                <a href="{{ url_for('admin_logs') }}" class="nav-item">📋 Logs</a>
                <a href="{{ url_for('admin_settings') }}" class="nav-item">⚙️ Configurações</a>
            {% endif %}

            <a href="{{ url_for('relatar_problema') }}" class="nav-item">🐛 Relatar Problema</a>

            <button class="theme-toggle" onclick="alternarTema()">
                <span class="theme-icon">{{ '🌙' if usuario.tema == 'light' else '☀️' }}</span>
            </button>

            <a href="{{ url_for('logout') }}" class="nav-item" style="color: var(--danger);">🚪 Sair</a>
        </nav>
    </div>
    {% endif %}

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Alternância de tema
        async function alternarTema() {
            try {
                const response = await fetch('{{ url_for("alternar_tema") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.documentElement.setAttribute('data-theme', data.tema);

                    // Atualiza o ícone
                    const themeIcon = document.querySelector('.theme-icon');
                    themeIcon.textContent = data.tema === 'light' ? '🌙' : '☀️';
                }
            } catch (error) {
                console.error('Erro ao alternar tema:', error);
            }
        }

        // Heartbeat para manter status online
        {% if usuario %}
        setInterval(() => {
            fetch('{{ url_for("heartbeat") }}', { method: 'POST' })
                .catch(err => console.log('Heartbeat error:', err));
        }, 60000); // A cada minuto
        {% endif %}

        // Auto-dismiss flash messages
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash');
            flashMessages.forEach(flash => {
                setTimeout(() => {
                    flash.style.opacity = '0';
                    flash.style.transform = 'translateY(-20px)';
                    setTimeout(() => flash.remove(), 300);
                }, 5000);
            });
            // Toast de conquista via evento customizado
            window.addEventListener('achievement-unlocked', function(e) {
                const data = e.detail || {};
                const div = document.createElement('div');
                div.className = 'flash flash-success';
                div.textContent = `🏆 Conquista desbloqueada: ${data.name}`;
                document.querySelector('.container').prepend(div);
                setTimeout(() => { div.style.opacity='0'; div.style.transform='translateY(-20px)'; setTimeout(()=>div.remove(), 300); }, 4000);
            });
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
